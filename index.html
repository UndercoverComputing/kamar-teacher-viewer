<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Teacher Viewer</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<h1>Teacher Viewer</h1>

<div id="upload-area">
  <p>Drop your .ics file here or click to select it</p>
  <input type="file" id="fileInput" accept=".ics,text/calendar" />
  <br><br>
  <button onclick="loadFile()">Load my timetable</button>
  <div class="instructions-link">
    <a href="instructions.html">How to get your ICS file →</a>
  </div>
</div>

<div id="result"></div>

<script>
  fetch("https://api.counterapi.dev/v2/undercover-computings-team-2605/timetable/up")
    .catch(() => {});
</script>
  
<script>
// Teacher code → name mapping (unchanged from your last version)
const teacherMap = {
  "FL": "FLYNN J",
  "PE": "PETERS F",
  "AG": "ANGELL J",
  "FE": "FURZE Mrs B",
  "PL": "POOLE G",
  "AN": "ANDER Mrs JD",
  "GD": "GIDDY G",
  "PR": "PRASAD J",
  "AR": "ARCHER R",
  "GO": "GOODALL Mrs H",
  "ΡΙ": "PRICE L",
  "ARM": "ARMES T",
  "JI": "JIN Ms C",
  "PN": "PINER A",
  "AK": "ATKINS DP",
  "RAFT": "RATFORD Mrs R",
  "JY": "JOYCE Ms R",
  "RB": "ROBINSON D",
  "BN": "BENNETT B",
  "HA": "HACKER MS K",
  "RO": "ROBERTS Mrs A",
  "BU": "BUBLITZ D",
  "HZ": "HALE Mrs L",
  "RN": "ROBERTSON MSR",
  "CD": "CARDY A",
  "HN": "HANNAH G",
  "RW": "ROWSON K",
  "CK": "CLARK R",
  "HT": "HARTMANN F",
  "RU": "RUSSELL H",
  "CL": "CLEAVER M",
  "HV": "HARVEY C",
  "SU": "SAUL G",
  "CE": "CLELAND Mrs A",
  "HW": "HEWLETT P",
  "SL": "SILVA W",
  "CT": "COATES H",
  "HL": "HOLDOM Mrs A",
  "SO": "SOMERS M",
  "CA": "COOPER MS A",
  "HP": "HOPE A",
  "SOM": "SOMERS Mrs S",
  "CP": "COOPER Mrs A",
  "IN": "INGLE Mrs S",
  "ST": "STANDISH T",
  "CO": "CORLETT B",
  "KG": "KEEGAN J",
  "SN": "STONES J",
  "KC": "CRADDOCK Ms K",
  "KL": "KILGOUR Mrs K",
  "SG": "SIGURDSSON M",
  "CY": "CREERY N",
  "LC": "LOCK A",
  "ΤΟ": "TOWNES M",
  "CR": "CREERY R",
  "LU": "LUKE C",
  "TN": "TRENT Ms H",
  "DR": "DARKE Mrs S",
  "MK": "MAAKA M",
  "TR": "TREWEEK V",
  "DA": "DAVIES E",
  "JM": "MARAKI J",
  "TG": "TUNG MS L",
  "DAV": "DAVIS G",
  "MH": "MARSHALL J",
  "TE": "TURNER J",
  "DAVY": "DAVY J",
  "MA": "MATUKU Mrs C",
  "VA": "VAN WYK D",
  "DB": "DOBBIE J",
  "MX": "MAXIM Mrs R",
  "WA": "WATTS M",
  "DO": "DROUGHT W",
  "MG": "MCGRATH T",
  "WG": "WIRINGI J",
  "DN": "DUNNET B",
  "MO": "MOORE Mrs T",
  "WI": "WISNEWSKI R",
  "ED": "EDMONDS J",
  "MU": "MUIR S",
  "WR": "WRIGHT A",
  "FQ": "FARQUHAR J",
  "KP": "PARKER Dr K",
  "WT": "WRIGHT Dr J",
  "FI": "FITZPATRICK B",
  "PG": "PENG S",
  "YO": "YOUNGER L",
  "HR": "HANAN R",
  "RA": "ARCHER Ms R",
  "PI": "PRICEL",
  "AR": "ARCHERR",
  "RN": "ROBERTSON MSR",
  "BA": "BAILEY-NOWELL Ms A",
  "HK": "HAWKINS J",
  "BR": "BROWN L",
  "RT": "RUSHTON C",
  "MJ": "JAMES M",
  "JN": "JOHNSTONE Ms J",
  "SH": "SCHAARET",
  "TC": "CLARK-PUIAT",
  "LA": "LAURENCE P",
  "JS": "SMITH J",
  "SI": "SMITH MS M",
  "TM": "TEMPLETON Mrs R",
  "ES": "ESTRABILLO P",
  "OK": "O'KEEFFE P",
  "OA": "OAKES K",
  "PK": "PERKINS MS B"
};

function loadFile() {
  const fileInput = document.getElementById('fileInput');
  const file = fileInput.files[0];
  if (!file) {
    alert("Please select your .ics file first.");
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    parseAndShow(e.target.result);
  };
  reader.readAsText(file);
}

function parseAndShow(ics) {
  const lines = ics.split(/\r?\n/);
  let events = [];
  let current = null;

  for (let line of lines) {
    line = line.trim();
    if (line === "BEGIN:VEVENT") {
      current = {};
    } else if (line === "END:VEVENT") {
      if (current && current.summary) events.push(current);
      current = null;
    } else if (current) {
      if (line.startsWith("SUMMARY:")) current.summary = line.slice(8).trim();
      if (line.startsWith("LOCATION:")) current.location = line.slice(9).trim();
      if (line.startsWith("DESCRIPTION:")) current.description = line.slice(12).trim();
    }
  }

  const subjects = {};

  for (let ev of events) {
    let subj = ev.summary?.trim();
    // Skip assemblies + all four houses
    if (!subj || 
        subj.includes("ASSEMBLY") || 
        subj.includes("BARAK") || 
        subj.includes("SYME") || 
        subj.includes("DONNELLY") || 
        subj.includes("HATHERLY")) {
      continue;
    }

    let classCode = subj.split(" ")[0];

    if (!subjects[classCode]) {
      subjects[classCode] = {
        display: subj,
        rooms: new Map(),
        teachers: new Map(),
        count: 0
      };
    }

    const s = subjects[classCode];
    s.count++;

    if (ev.location) {
      s.rooms.set(ev.location, (s.rooms.get(ev.location) || 0) + 1);
    }
    if (ev.description && ev.description.length <= 5 && /^[A-Z]+$/.test(ev.description)) {
      const code = ev.description.trim();
      s.teachers.set(code, (s.teachers.get(code) || 0) + 1);
    }
  }

  let html = '<h2>Your Classes</h2>';

  if (Object.keys(subjects).length === 0) {
    html += '<p class="no-data">No regular classes found in this file.</p>';
  } else {
    html += '<table><thead><tr><th>Class</th><th>Location</th><th>Teacher</th></tr></thead><tbody>';

    Object.keys(subjects).sort().forEach(code => {
      const s = subjects[code];

      let room = "—";
      if (s.rooms.size > 0) {
        const top = [...s.rooms.entries()].sort((a,b)=>b[1]-a[1])[0];
        room = top[0];
      }

      let teacherDisplay = "—";
      if (s.teachers.size > 0) {
        const top = [...s.teachers.entries()].sort((a,b)=>b[1]-a[1])[0];
        const code = top[0];

        if (code === "NTECH") {
          teacherDisplay = "NTECH<br><span class='unavailable'>(unavailable)</span>";
        } else {
          const name = teacherMap[code];
          teacherDisplay = code;
          if (name) teacherDisplay += `<br><strong>${name}</strong>`;
          else teacherDisplay += `<br><span class='unavailable'>(name not listed)</span>`;
        }
      }

      html += `<tr>
        <td class="subject">${s.display}</td>
        <td>${room}</td>
        <td>${teacherDisplay}</td>
      </tr>`;
    });

    html += '</tbody></table>';
  }

  document.getElementById('result').innerHTML = html;

  // Only increment counter after successful parse (real upload happened)
  incrementUploadCounter();
}

// Counter - only called after successful .ics processing
function incrementUploadCounter() {
  fetch('https://api.counterapi.xyz/hit/undercover-computings-team-2605/timetable-processed/count', { mode: 'no-cors' })
    .catch(() => {});
}
</script>

<!-- Simple counter display at bottom -->
<div style="text-align: center; margin: 3rem 0; color: #777; font-size: 0.9rem;">
  Total timetables processed: <span id="uploadCount">loading...</span>
</div>

<script>
// Load current count on page load (non-blocking)
fetch('https://api.counterapi.xyz/get/undercover-computings-team-2605/timetable-processed/count', { mode: 'no-cors' })
  .then(r => r.json ? r.json() : Promise.reject())
  .then(data => {
    document.getElementById('uploadCount').innerText = data.value || 'many';
  })
  .catch(() => {
    document.getElementById('uploadCount').innerText = 'many';
  });
</script>

</body>
</html>

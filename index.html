<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Teacher Viewer</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<h1>Teacher Viewer</h1>

<div id="upload-area">
  <p>Drop your .ics file here or click to select it</p>
  <input type="file" id="fileInput" accept=".ics,text/calendar" />
  <br><br>
  <button onclick="loadFile()">Load my timetable</button>
  <div class="instructions-link">
    <a href="instructions.html" target="_blank">How to get your ICS file →</a>
  </div>
</div>

<div id="result"></div>

<!-- Global counter display -->
<div id="global-counter" style="text-align: center; margin: 3rem 0; color: #777; font-size: 0.95rem;">
  Total timetables processed: <span id="upload-count">loading...</span>
</div>

<script>
// Teacher code → name mapping (unchanged)
const teacherMap = {
  "AN": "Ander J",
  "AG": "Angell J",
  "AR": "Archer R",
  "RA": "Archer R",
  "AK": "Atkins D",
  "BA": "Bailey-Nowell A",
  "BN": "Bennett B",
  "BG": "Berghan R",
  "BR": "Brown L",
  "CD": "Cardy A",
  "CL": "Cleaver M",
  "CE": "Cleland A",
  "CK": "Clark R",
  "TC": "Clark-Puia T",
  "CT": "Coates H",
  "CP": "Cooper A",
  "CA": "Cooper A",
  "CO": "Corlett B",
  "KC": "Craddock K",
  "CY": "Creery N",
  "CR": "Creery R",
  "HL": "Cripps A",
  "JD": "Davy J",
  "DO": "Drought W",
  "DN": "Dunnet B",
  "ES": "Estrabillo P",
  "FQ": "Farquhar J",
  "FS": "Featherston R",
  "FI": "Fitzpatrick B",
  "FL": "Flynn J",
  "FZ": "Furze B",
  "GD": "Giddy G",
  "GO": "Goodall H",
  "HA": "Hacker K",
  "HZ": "Hale L",
  "HR": "Hanan R",
  "HN": "Hannah G",
  "HT": "Hartmann F",
  "HV": "Harvey C",
  "HW": "Hewlett P",
  "HP": "Hope A",
  "IN": "Ingle S",
  "MJ": "James M",
  "JN": "Johnstone J",
  "JY": "Joyce R",
  "KG": "Keegan J",
  "KL": "Kilgour K",
  "LA": "Laurence P",
  "LC": "Lock A",
  "LU": "Luke C",
  "MK": "Maaka M",
  "JM": "Maraki J",
  "MH": "Marshall J",
  "MA": "Matuku C",
  "MX": "Maxim R",
  "MC": "McHugh C",
  "MG": "McGrath T",
  "MR": "Moore S",
  "MO": "Moore T",
  "MU": "Muir S",
  "OK": "O'Keeffe P",
  "KP": "Parker K",
  "PG": "Peng S",
  "PK": "Perkins B",
  "PE": "Peters F",
  "PN": "Piner A",
  "PL": "Poole G",
  "PR": "Prasad J",
  "PI": "Price L",
  "RO": "Roberts A",
  "RN": "Robertson R",
  "RB": "Robinson D",
  "RW": "Rowson K",
  "RU": "Russell H",
  "RT": "Rushton C",
  "SH": "Schaare T",
  "SG": "Siggurdson M",
  "SL": "Silva W",
  "SM": "Simanke D",
  "SO": "Somers M",
  "ST": "Standish T",
  "SN": "Stones J",
  "AT": "Taylor A",
  "TM": "Templeton R",
  "TN": "Trent H",
  "TR": "Treweek V",
  "TG": "Tung L",
  "TE": "Turner J",
  "VA": "Van Wyk D",
  "WA": "Watts M",
  "WG": "Wiringi J",
  "WI": "Wisnewski R",
  "WR": "Wright A",
  "YO": "Younger L"
};

function loadFile() {
  const fileInput = document.getElementById('fileInput');
  const file = fileInput.files[0];
  if (!file) {
    alert("Please select your .ics file first.");
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    parseAndShow(e.target.result);
  };
  reader.readAsText(file);
}

function parseAndShow(ics) {
  const lines = ics.split(/\r?\n/);
  let events = [];
  let current = null;

  for (let line of lines) {
    line = line.trim();
    if (line === "BEGIN:VEVENT") {
      current = {};
    } else if (line === "END:VEVENT") {
      if (current && current.summary) events.push(current);
      current = null;
    } else if (current) {
      if (line.startsWith("SUMMARY:")) current.summary = line.slice(8).trim();
      if (line.startsWith("LOCATION:")) current.location = line.slice(9).trim();
      if (line.startsWith("DESCRIPTION:")) current.description = line.slice(12).trim();
    }
  }

  const subjects = {};

  for (let ev of events) {
    let subj = ev.summary?.trim();
    if (!subj || 
        subj.includes("ASSEMBLY") || 
        subj.includes("BARAK") || 
        subj.includes("SYME") || 
        subj.includes("DONNELLY") || 
        subj.includes("HATHERLY")) {
      continue;
    }

    let classCode = subj.split(" ")[0];

    if (!subjects[classCode]) {
      subjects[classCode] = {
        display: subj,
        rooms: new Map(),
        teachers: [],  // array to preserve order
        count: 0
      };
    }

    const s = subjects[classCode];
    s.count++;

    if (ev.location) {
      s.rooms.set(ev.location, (s.rooms.get(ev.location) || 0) + 1);
    }

    if (ev.description) {
      // Split on comma or space, clean, avoid duplicates
      const codes = ev.description
        .split(/[, ]+/)
        .map(c => c.trim().toUpperCase())
        .filter(c => /^[A-Z]{2,}$/.test(c));

      codes.forEach(code => {
        if (!s.teachers.includes(code)) s.teachers.push(code);
      });
    }
  }

  let html = '<h2>Your Classes</h2>';

  if (Object.keys(subjects).length === 0) {
    html += '<p class="no-data">No regular classes found in this file.</p>';
  } else {
    html += '<table><thead><tr><th>Class</th><th>Location</th><th>Teacher</th></tr></thead><tbody>';

    Object.keys(subjects).sort().forEach(code => {
      const s = subjects[code];

      let room = "—";
      if (s.rooms.size > 0) {
        const top = [...s.rooms.entries()].sort((a,b)=>b[1]-a[1])[0];
        room = top[0];
      }

      let teacherDisplay = "—";
      if (s.teachers.length > 0) {
        const codesLine = s.teachers.join(',');
        const namesLine = s.teachers.map(tcode => {
          const name = teacherMap[tcode] || '';
          return name ? `<strong>${name}</strong>` : '';
        }).join(', ');

        teacherDisplay = `${codesLine}<br>${namesLine}`;
      }

      html += `<tr>
        <td class="subject">${s.display}</td>
        <td>${room}</td>
        <td>${teacherDisplay}</td>
      </tr>`;
    });

    html += '</tbody></table>';
  }

  document.getElementById('result').innerHTML = html;

  incrementUploadCounter();
}

// Increment the counter
function incrementUploadCounter() {
  fetch('https://api.counterapi.dev/v2/undercover-computings-team-2605/timetable/up', {
    method: 'GET',
    mode: 'cors',
    cache: 'no-cache'
  }).catch(() => {});  // silent fail is fine
}

// Load and display current up_count
function loadUploadCount() {
  fetch('https://api.counterapi.dev/v2/undercover-computings-team-2605/timetable', {
    method: 'GET',
    mode: 'cors',
    cache: 'no-cache'
  })
    .then(response => {
      if (!response.ok) throw new Error('Response not OK');
      return response.json();
    })
    .then(data => {
      if (data && data.data && typeof data.data.up_count === 'number') {
        document.getElementById('upload-count').innerText = data.data.up_count;
      } else {
        document.getElementById('upload-count').innerText = 'many';
      }
    })
    .catch(() => {
      document.getElementById('upload-count').innerText = 'many';
    });
}

// Load count when page opens
document.addEventListener('DOMContentLoaded', loadUploadCount);
</script>

</body>
</html>





